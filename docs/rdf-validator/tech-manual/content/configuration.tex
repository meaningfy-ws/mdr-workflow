\section{Configuration}
\label{sec:configuration}
At deployment and at runtime, the service configurations are provided through OS environment variables available in the \textit{.env} file. The role of the \textit{.env} file is to enable the system administrators to easily change default configurations as necessary in the context of their environment.

The suite of micro-services is built, started and shut down via Makefile commands.

In order to avoid hard coding parameters, they are defined externally in the \textit{.env}. Having them in a single file makes  sense and it is more pragmatic, as you can see and manage all parameters in one place, add the file to the version control system (the contents of the file will evolve and be in sync with the actual code) and have different files for different environments.

The following sections describe the configuration options available for each of the services.

\subsection{RDF validator}

The RDF validator is an online platform for validating RDF data with SHACL shape definitions. It exposes an API and an UI. The RDF validator API is the core service providing the RDF validation functionality. The URL and port are described below, as well as the request timeout:

\begin{longtable}[c]{@{}p{3.5cm}p{3.5cm}l@{}}
	\toprule
	Description                       & Value            & Associated variable               \\* \midrule
	\endfirsthead
	%
	\multicolumn{3}{c}%
	{{\bfseries Table \thetable\ continued from previous page}}                              \\
	\endhead
	%
	\bottomrule
	\endfoot
	%
	\endlastfoot
	%
	Service URL                       & http://localhost & RDF\_VALIDATOR\_API\_LOCATION     \\
	Service API port                  & 4010             & RDF\_VALIDATOR\_API\_PORT         \\
	Is in debug mode                  & False            & RDF\_VALIDATOR\_DEBUG             \\
	Service UI port                   & 8030             & RDF\_VALIDATOR\_UI\_PORT          \\
	Web server worker process timeout & 1200             & RDF\_VALIDATOR\_GUNICORN\_TIMEOUT \\* \bottomrule
	\caption{RDF validator configurations}
	\label{tab:rdf-validator-configuration}                                                  \\
\end{longtable}

\subsection{Celery worker}
Celery is a simple, flexible, and reliable distributed system to process vast amounts of messages, while providing operations with the tools required to maintain such a system. Itâ€™s a task queue with focus on real-time processing.

In the RDF validator project it serves the purpose of enabling multiprocessing of validation report generation.

The RDF validator application uses the following Celery environment variables

\begin{longtable}[c]{@{}p{3.5cm}p{3.5cm}l@{}}
	\toprule
	Description    & Value                      & Associated variable             \\* \midrule
	\endfirsthead
	%
	\multicolumn{3}{c}%
	{{\bfseries Table \thetable\ continued from previous page}}                   \\
	\endhead
	%
	\bottomrule
	\endfoot
	%
	\endlastfoot
	%
	Redis location & \texttt{redis://localhost} & RDF\_VALIDATOR\_REDIS\_LOCATION \\
	Redis port     & 6379                       & RDF\_VALIDATOR\_REDIS\_PORT     \\*\bottomrule
	\caption{Celery environment configurations}
	\label{tab:validator-celery-env}                                              \\
\end{longtable}

More about the implementation of multiprocessing can be found in the \textit{adapters/celery.py}. A fragment of how celery is used and the asynchronous file validation is presented below:

\begin{lstlisting}
celery_worker = Celery('rdf-validator-tasks',
	broker=config.RDF_VALIDATOR_REDIS_SERVICE,
	backend=config.RDF_VALIDATOR_REDIS_SERVICE)
celery_worker.conf.update(result_extended=True)

CELERY_VALIDATE_FILE = 'validate_file'


@celery_worker.task(name=CELERY_VALIDATE_FILE, bind=True)
def async_validate_file(self, uid: str, data_file: str, shacl_shapes: list, db_cleanup_location: str, application_profile: str = ''):
	...
\end{lstlisting}

\subsection{Configure and read logs}
Every service provided by the RDF validator has it's own log history and is configurable through the aforementioned \textit{.env} file. The current configuration accepts a relative path to where the logs to be written \textit{logs/api.log}, for example.

\texttt{logs/celery.log} contains the logs of the Celery workers. This contains the logs of the tasks that are being processed; here is where you would do most of the log hunting to debug inconsistent behavior.

\subsubsection{API log example}
\begin{lstlisting}
[2022-01-02 15:34:35 +0000] [8] [INFO] Starting gunicorn 20.1.0
[2022-01-02 15:34:35 +0000] [8] [DEBUG] Arbiter booted
[2022-01-02 15:34:35 +0000] [8] [INFO] Listening at: http://0.0.0.0:4010 (8)
[2022-01-02 15:34:35 +0000] [8] [INFO] Using worker: sync
[2022-01-02 15:34:35 +0000] [11] [INFO] Booting worker with pid: 11
[2022-01-02 15:34:35 +0000] [12] [INFO] Booting worker with pid: 12
[2022-01-02 15:34:35 +0000] [8] [DEBUG] 2 workers
[2022-01-02 15:37:04 +0000] [11] [DEBUG] POST /validate/ap/file
[2022-01-02 15:37:04 +0000] [11] [DEBUG] start validate file endpoint
[2022-01-02 15:37:04 +0000] [11] [DEBUG] finish request to validate file endpoint
\end{lstlisting}

\subsubsection{UI log example}
\begin{lstlisting}
[2022-01-02 15:34:45 +0000] [11] [DEBUG] GET /
[2022-01-02 15:34:45 +0000] [11] [DEBUG] request index view
[2022-01-02 15:34:45 +0000] [11] [DEBUG] render index view
\end{lstlisting}

The RDF validator application uses the following environment variables to define logs location:

\begin{longtable}[c]{@{}p{3.5cm}p{3.5cm}l@{}}
	\toprule
	Description & Value           & Associated variable          \\* \midrule
	\endfirsthead
	%
	\multicolumn{3}{c}%
	{{\bfseries Table \thetable\ continued from previous page}}  \\
	\endhead
	%
	\bottomrule
	\endfoot
	%
	\endlastfoot
	%
	API logs    & logs/api.log    & RDF\_VALIDATOR\_API\_LOGS    \\
	UI logs     & logs/ui.log     & RDF\_VALIDATOR\_UI\_LOGS     \\
	Celery logs & logs/celery.log & RDF\_VALIDATOR\_CELERY\_LOGS \\* \bottomrule
	\caption{RDF validator log configurations}
	\label{tab:rdf-validator-log}                                \\
\end{longtable}
